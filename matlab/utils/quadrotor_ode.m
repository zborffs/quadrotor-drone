function out = quadrotor_ode(t, state, parameters)
% quadrotor_ode(t, x, p) is the 

% state variables
u = state(4);
v = state(5);
w = state(6);
phi = state(7);
theta = state(8);
psi = state(9);
p = state(10);
q = state(11);
r = state(12);

x = state(1:12);
xhat = state(13:24);
z = state(25:28);

% model parameters
M = parameters.M;
m = parameters.m;
R = parameters.R;
L = parameters.L;
l = parameters.l;
g = parameters.g;
k1 = parameters.k1;
k2 = parameters.k2;

A = [
    0         0         0    1.0000         0         0         0         0         0         0         0         0;
    0         0         0         0    1.0000         0         0         0         0         0         0         0;
    0         0         0         0         0    1.0000         0         0         0         0         0         0;
    0         0         0         0         0         0         0   -9.8100         0         0         0         0;
    0         0         0         0         0         0    9.8100         0         0         0         0         0;
    0         0         0         0         0         0         0         0         0         0         0         0;
    0         0         0         0         0         0         0         0         0    1.0000         0         0;
    0         0         0         0         0         0         0         0         0         0    1.0000         0;
    0         0         0         0         0         0         0         0         0         0         0    1.0000;
    0         0         0         0         0         0         0         0         0         0         0         0;
    0         0         0         0         0         0         0         0         0         0         0         0;
    0         0         0         0         0         0         0         0         0         0         0         0
];
B = [
                   0                   0                   0                   0;
                   0                   0                   0                   0;
                   0                   0                   0                   0;
                   0                   0                   0                   0;
                   0                   0                   0                   0;
  -1.400714103591450   1.400714103591450  -1.400714103591450   1.400714103591450;
                   0                   0                   0                   0;
                   0                   0                   0                   0;
                   0                   0                   0                   0;
                   0  -2.918154382482188                   0   2.918154382482188;
   2.918154382482188                   0  -2.918154382482188                   0;
   0.227272727272727   0.227272727272727   0.227272727272727   0.227272727272727
];
H = [
   4.006059176991294   0.000000000000002  -0.000000000000000  -0.000000000000000  -0.817991130271465   0.000000000000000  0.000000000000002  -0.167376242586968  -0.000000000000001;
  -0.000000000000003   4.006059176991289  -0.000000000000001   0.817991130271468   0.000000000000002   0.000000000000001   0.167376242586970  -0.000000000000001  -0.00000000000000;
  -0.000000000000000   0.000000000000001   1.732050807568879  -0.000000000000000   0.000000000000000  -0.000000000000000   0.000000000000000  -0.000000000000000  -0.000000000000000;
   7.872817212670737   0.000000000000011  -0.000000000000001  -0.000000000000000  -3.985152117062770   0.000000000000003   0.000000000000005  -1.151519116869969  -0.000000000000001;
  -0.000000000000012   7.872817212670718  -0.000000000000005   3.985152117062773   0.000000000000006   0.000000000000004   1.151519116869966  -0.000000000000001  -0.000000000000001;
  -0.000000000000000   0.000000000000001   0.999999999999999  -0.000000000000000   0.000000000000000  -0.000000000000000  -0.000000000000000  -0.000000000000000  -0.000000000000000;
  -0.000000000000001   0.817991130271459   0.000000000000000   0.987768420465962   0.000000000000000   0.000000000000000   0.404010018265919  -0.000000000000000  -0.000000000000000;
  -0.817991130271467  -0.000000000000003   0.000000000000001  -0.000000000000000   0.987768420465962  -0.000000000000001  -0.000000000000001   0.404010018265919   0.000000000000000;
  -0.000000000000000  -0.000000000000001   0.000000000000000  -0.000000000000000   0.000000000000000   1.287188505811166   0.000000000000000   0.000000000000000   0.414213562373095;
  -0.000000000000000   0.167376242586965  -0.000000000000000   0.404010018265918   0.000000000000000   0.000000000000000   0.899311458037893   0.000000000000000   0.000000000000000;
  -0.167376242586967  -0.000000000000001   0.000000000000000  -0.000000000000000   0.404010018265918  -0.000000000000001  -0.000000000000000   0.899311458037893   0.000000000000000;
   0.000000000000000   0.000000000000000   0.000000000000000  -0.000000000000000  -0.000000000000000   0.414213562373095  -0.000000000000000  -0.000000000000000   0.910179721124455
];

C = [
     1     0     0     0     0     0     0     0     0     0     0     0;
     0     1     0     0     0     0     0     0     0     0     0     0;
     0     0     1     0     0     0     0     0     0     0     0     0;
     0     0     0     0     0     0     1     0     0     0     0     0;
     0     0     0     0     0     0     0     1     0     0     0     0;
     0     0     0     0     0     0     0     0     1     0     0     0;
     0     0     0     0     0     0     0     0     0     1     0     0;
     0     0     0     0     0     0     0     0     0     0     1     0;
     0     0     0     0     0     0     0     0     0     0     0     1
];

C2 = [
     1     0     0     0     0     0     0     0     0     0     0     0;
     0     1     0     0     0     0     0     0     0     0     0     0;
     0     0     1     0     0     0     0     0     0     0     0     0;
     0     0     0     0     0     0     0     0     1     0     0     0    
];

K1 = [
  -1.674244784831501   0.000000000000009  -1.016264801768898  -1.628534516152433   0.000000000000008  -0.782794147314374   0.000000000000018   7.025177770998418   1.450963485097345   0.000000000000002   1.705111264474679   1.855295035085838;
   0.000000000000007  -1.674244784831507   1.016264801768899   0.000000000000002  -1.628534516152438   0.782794147314373  -7.025177770998422  -0.000000000000011   1.450963485097345  -1.705111264474683  -0.000000000000002   1.855295035085839;
   1.674244784831503  -0.000000000000007  -1.016264801768899   1.628534516152434  -0.000000000000006  -0.782794147314375  -0.000000000000013  -7.025177770998424   1.450963485097343  -0.000000000000001  -1.705111264474680   1.855295035085839;
  -0.000000000000005   1.674244784831506   1.016264801768897  -0.000000000000002   1.628534516152436   0.782794147314376   7.025177770998413   0.000000000000009   1.450963485097342   1.705111264474681   0.000000000000002   1.855295035085834
];

K2 = [
  -0.707106781186549   0.000000000000003  -0.500000000000001   0.500000000000000;
   0.000000000000004  -0.707106781186555   0.500000000000000   0.500000000000000;
   0.707106781186549  -0.000000000000005  -0.500000000000001   0.499999999999999;
  -0.000000000000002   0.707106781186556   0.500000000000001   0.499999999999998
];

% control
u_control = compute_control(state, parameters);
u1 = u_control(1);
u2 = u_control(2);
u3 = u_control(3);
u4 = u_control(4);

% system 
out = [
    w*(sin(phi)*sin(psi) + cos(phi)*cos(psi)*sin(theta)) - v*(cos(phi)*sin(psi) - cos(psi)*sin(phi)*sin(theta)) + u*cos(psi)*cos(theta);
    v*(cos(phi)*cos(psi) + sin(phi)*sin(psi)*sin(theta)) - w*(cos(psi)*sin(phi) - cos(phi)*sin(psi)*sin(theta)) + u*cos(theta)*sin(psi);
    w*cos(phi)*cos(theta) - u*sin(theta) + v*cos(theta)*sin(phi);
    r*v - q*w - g*sin(theta);
    p*w - r*u + g*cos(theta)*sin(phi);
    q*u - p*v - k1*(u1^2 + u2^2 + u3^2 + u4^2)/(M + 4*m) + g*cos(phi)*cos(theta);
    p + r*cos(phi)*tan(theta) + q*sin(phi)*tan(theta);
    q*cos(phi) - r*sin(phi);
    (r*cos(phi))/cos(theta) + (q*sin(phi))/cos(theta);
    (l*(k1*u2^2 - k1*u4^2))/((2*M*R^2)/5 + 2*m*l^2) - (2*l^2*m*q*r)/((2*M*R^2)/5 + 2*m*l^2);
    (l*(k1*u1^2 - k1*u3^2))/((2*M*R^2)/5 + 2*m*l^2) + (2*l^2*m*p*r)/((2*M*R^2)/5 + 2*m*l^2);
    (k2*(u1 + u2 + u3 + u4))/((2*M*R^2)/5 + 4*m*l^2);
    A * xhat + B * -(K1 * xhat + K2 * z) + H * C * (x - xhat);
    C2 * x - [1; 1; -1.0; pi/2] % reference is 0...
];
end